<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedExcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- 1. CORE VARIABLES & ANIMATIONS --- */
        :root {
            --ease-snap: cubic-bezier(0.19, 1, 0.22, 1);
            --ease-out: cubic-bezier(0.33, 1, 0.68, 1);
        }
        
        body { 
            -webkit-user-select: none; 
            user-select: none; 
            background-color: #0f172a;
            overflow: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* --- LOADER STYLES (From your logic) --- */
        .loader-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f172a; /* Match body bg */
            z-index: 10000; /* Highest priority */
            transition: opacity 0.4s ease;
        }
        
        .loader-content { text-align: center; }
        
        /* Simple spinner for MedExcel style */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-left-color: #60A5FA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .loading-text {
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            animation: pulse 1.5s infinite;
        }

        /* --- OK DIALOG (Blocking Modal) --- */
        .ok-backdrop {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        .ok-dialog {
            width: 90%;
            max-width: 400px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            color: white;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s var(--ease-out);
        }
        .ok-backdrop.active .ok-dialog {
            transform: scale(1);
            opacity: 1;
        }

        /* --- APP ANIMATIONS --- */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }
        .animate-blink { animation: blink 4s infinite; transform-origin: center; }

        @keyframes popIn {
            0% { transform: scale(0.8) translateY(10px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s var(--ease-snap) forwards; }

        .aurora-glow { filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.4)) drop-shadow(0 0 20px rgba(59, 130, 246, 0.2)); }

        /* Screen Transitions */
        .screen {
            transition: opacity 0.4s var(--ease-snap), transform 0.4s var(--ease-snap);
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
        }
        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }
        .screen.hidden-screen { display: none; }

        /* Confetti */
        .confetti-piece {
            position: absolute;
            width: 8px; height: 12px;
            top: 50%; left: 50%;
            opacity: 0;
            border-radius: 2px;
            pointer-events: none;
            z-index: 60;
        }
        /* Confetti Keyframes (Same as before) */
        @keyframes explode-1 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(-80px, -120px) scale(0.5) rotate(180deg); opacity:0; } }
        @keyframes explode-2 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(40px, -150px) scale(0.5) rotate(-180deg); opacity:0; } }
        @keyframes explode-3 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(-120px, -80px) scale(0.5) rotate(90deg); opacity:0; } }
        @keyframes explode-4 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(100px, -100px) scale(0.5) rotate(-90deg); opacity:0; } }
        @keyframes explode-5 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(-50px, 100px) scale(0.5) rotate(45deg); opacity:0; } }
        @keyframes explode-6 { 0% { transform: translate(0,0) scale(1); opacity:1; } 100% { transform: translate(70px, 80px) scale(0.5) rotate(-45deg); opacity:0; } }
    </style>
</head>
<body class="bg-slate-900 font-sans text-white h-screen overflow-hidden relative">

    <div id="loaderScreen" class="loader-screen" role="status" aria-live="polite">
        <div class="loader-content">
            <div class="spinner"></div>
            <div class="loading-text">INITIALIZING...</div>
        </div>
    </div>

    <div id="okBackdrop" class="ok-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="ok-dialog" role="document">
            <h3 id="okTitle" class="text-lg font-bold text-white mb-2">Notice</h3>
            <p id="okMessage" class="text-slate-300 text-sm mb-6 leading-relaxed">Message goes here</p>
            <div class="flex justify-end gap-3">
                <button id="okCancel" class="px-4 py-2 rounded-xl text-slate-400 font-bold text-sm hover:text-white transition">Cancel</button>
                <button id="okConfirm" class="px-6 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg shadow-blue-900/50 transition transform active:scale-95">OK</button>
            </div>
        </div>
    </div>

    <div id="splashScreen" class="screen active fixed inset-0 z-50 flex flex-col items-center justify-between p-6 bg-slate-900">
        
        <div class="flex-1 flex flex-col items-center justify-center w-full">
            <div id="splashLogo" class="mb-8 animate-float aurora-glow">
                <svg width="200" height="200" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="30" width="60" height="65" rx="28" fill="#60A5FA"/>
                    <ellipse cx="50" cy="70" rx="20" ry="16" fill="#BFDBFE"/> 
                    <path d="M22 35 V42 Q50 55 78 42 V35" fill="#1E293B"/>
                    <g stroke="#1E293B" stroke-width="3">
                        <circle cx="35" cy="52" r="12" fill="white"/>
                        <circle cx="65" cy="52" r="12" fill="white"/>
                        <path d="M47 52 L53 52" stroke-width="3"/> 
                    </g>
                    <g class="animate-blink">
                        <circle cx="35" cy="52" r="4" fill="#1E293B"/>
                        <circle cx="37" cy="50" r="1.5" fill="white"/>
                        <circle cx="65" cy="52" r="4" fill="#1E293B"/>
                        <circle cx="67" cy="50" r="1.5" fill="white"/>
                    </g>
                    <path d="M45 62 L55 62 L50 69 L45 62Z" fill="#F59E0B"/>
                    <path d="M50 10 L85 25 L50 40 L15 25 Z" fill="#1E293B"/>
                    <circle cx="50" cy="25" r="2" fill="#F59E0B"/>
                    <path d="M50 25 Q88 25 88 50" stroke="#F59E0B" stroke-width="2" fill="none"/>
                    <circle cx="88" cy="50" r="3" fill="#F59E0B"/>
                </svg>
            </div>
            
            <div class="flex items-baseline justify-center text-5xl font-extrabold text-white mb-2 tracking-wide">
                <span>Me</span><span class="relative -mr-1.99 text-[0.95em]">d</span><span>E</span><span>xcel</span>
            </div>

            <p class="text-slate-400 text-lg font-medium text-center max-w-xs leading-relaxed">
                Crush your exams. <br> Read and remember. Forever.
            </p>
        </div>

        <div class="w-full max-w-sm space-y-4 mb-4">
            <button onclick="navigate('splashScreen', 'introScreen', true)" 
                class="w-full bg-blue-500 hover:bg-blue-400 text-slate-900 font-extrabold text-sm py-4 rounded-2xl border-b-[6px] border-blue-700 active:border-b-0 active:translate-y-[6px] transition-all uppercase tracking-widest shadow-lg shadow-blue-900/50">
                Get Started
            </button>
            <button onclick="toggleLogin(true)" 
                class="w-full bg-slate-800 hover:bg-slate-700 text-blue-400 font-extrabold text-sm py-4 rounded-2xl border-2 border-slate-700 uppercase tracking-widest transition-all">
                I Already Have An Account
            </button>

            <!-- New Sign Up button (opens the login/signup modal in signup mode) -->
            <button onclick="toggleSignup()" class="w-full text-slate-300 hover:text-white font-bold text-xs uppercase tracking-widest py-3 border-2 border-slate-800 rounded-2xl transition-colors">
                Sign Up
            </button>
        </div>
    </div>

    <div id="loginScreen" class="hidden fixed inset-0 z-[60] flex flex-col bg-slate-900 p-6 transition-all duration-300 opacity-0 translate-y-10">
        
        <div class="flex items-center justify-between mb-10 mt-2">
            <button onclick="toggleLogin(false)" class="text-slate-400 hover:text-white transition p-2 -ml-2">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 id="loginHeading" class="text-slate-400 font-bold text-lg flex-1 text-center mr-6">Enter your details</h2>
        </div>

        <div class="w-full max-w-sm mx-auto">
            <div class="bg-slate-800 border-2 border-slate-700 rounded-2xl mb-6 overflow-hidden focus-within:border-slate-500 transition-colors">
                <input id="emailInput" type="text" placeholder="Username or email" class="w-full bg-transparent p-4 text-white placeholder-slate-500 font-medium outline-none border-b-2 border-slate-700">
                <div class="relative">
                    <input id="loginPassword" type="password" placeholder="Password" class="w-full bg-transparent p-4 text-white placeholder-slate-500 font-medium outline-none">
                    <button onclick="togglePassword()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-blue-400 transition">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>
            </div>

            <button id="signInBtn" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 font-extrabold text-sm py-3.5 rounded-2xl border-b-[4px] border-slate-800 active:border-b-0 active:translate-y-[4px] transition-all uppercase tracking-widest mb-6">
                Sign In
            </button>

            <button class="w-full text-blue-400 font-extrabold uppercase tracking-widest text-sm mb-12 hover:text-blue-300 transition">
                Forgot Password
            </button>

            <div class="mb-8">
                <button id="googleLoginBtn" class="w-full flex items-center justify-center gap-2 bg-slate-800 border-2 border-slate-700 rounded-2xl py-3 hover:bg-slate-700 transition active:scale-95">
                    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    <span class="text-slate-300 font-bold text-sm tracking-wide">GOOGLE</span>
                </button>
            </div>
        </div>
    </div>

    <div id="introScreen" class="screen hidden-screen fixed inset-0 z-40 flex flex-col items-center justify-between p-6 bg-slate-900">
        <button onclick="navigate('introScreen', 'splashScreen')" class="absolute top-6 left-6 z-50 text-slate-500 hover:text-white transition-colors p-2 rounded-full hover:bg-slate-800">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </button>
        <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50 flex items-center justify-center overflow-hidden">
            <div class="relative w-full max-w-xs h-[250px] flex items-center justify-center"></div>
        </div>
        <div class="w-full pt-2"></div>
        <div class="flex-1 flex flex-col items-center justify-center w-full -mt-10 relative z-10">
            <div class="speech-bubble relative bg-slate-800 border-2 border-slate-700 p-6 rounded-2xl mb-8 max-w-xs w-full shadow-xl">
                <h2 class="text-xl font-bold text-white mb-2">Hi, I'm Aurora!</h2>
                <p class="text-slate-300 text-lg leading-relaxed">
                    I'll help you create flashcards instantly and crush your exams.
                </p>
                <div class="absolute bottom-[-12px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[12px] border-t-slate-700"></div>
                <div class="absolute bottom-[-9px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-slate-800"></div>
            </div>

            <div id="introMascot" class="aurora-glow opacity-0">
                 <svg width="170" height="170" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="30" width="60" height="65" rx="28" fill="#60A5FA"/>
                    <ellipse cx="50" cy="70" rx="20" ry="16" fill="#BFDBFE"/> 
                    <path d="M22 35 V42 Q50 55 78 42 V35" fill="#1E293B"/>
                    <g stroke="#1E293B" stroke-width="3">
                        <circle cx="35" cy="52" r="12" fill="white"/>
                        <circle cx="65" cy="52" r="12" fill="white"/>
                        <path d="M47 52 L53 52" stroke-width="3"/> 
                    </g>
                    <g stroke="#1E293B" stroke-width="3" stroke-linecap="round">
                        <path d="M 29 54 Q 35 47 41 54" fill="none" />
                        <path d="M 59 54 Q 65 47 71 54" fill="none" />
                    </g>
                    <path d="M45 62 L55 62 L50 69 L45 62Z" fill="#F59E0B"/>
                    <path d="M50 10 L85 25 L50 40 L15 25 Z" fill="#1E293B"/>
                    <circle cx="50" cy="25" r="2" fill="#F59E0B"/>
                    <path d="M50 25 Q88 25 88 50" stroke="#F59E0B" stroke-width="2" fill="none"/>
                    <circle cx="88" cy="50" r="3" fill="#F59E0B"/>
                </svg>
            </div>
        </div>

        <div class="w-full max-w-sm mb-8 space-y-4 relative z-10">
            <!-- Updated: continue button now signs in as guest automatically -->
            <button onclick="continueAsGuest()" 
                class="w-full bg-blue-500 hover:bg-blue-400 text-slate-900 font-extrabold text-sm py-4 rounded-2xl border-b-[6px] border-blue-700 active:border-b-0 active:translate-y-[6px] transition-all uppercase tracking-widest shadow-lg shadow-blue-900/50">
                Continue
            </button>
        </div>
    </div>

    <script>
        // --- 1. LOADER CONTROLLER ---
        window.__loader = {
            startTime: Date.now(),
            minMs: 800, // Show loader for at least 800ms to look smooth
            authResolved: false,
            windowLoaded: false,
            redirecting: false,
            
            checkHide() {
                // If we are redirecting (Logged in or Guest), KEEP loader up.
                if (this.redirecting) return;

                if (this.authResolved && this.windowLoaded) {
                    const elapsed = Date.now() - this.startTime;
                    const remaining = Math.max(0, this.minMs - elapsed);
                    
                    setTimeout(() => {
                        const loader = document.getElementById('loaderScreen');
                        if(loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => {
                                loader.style.display = 'none';
                                // Enable interaction on main body
                                document.body.style.pointerEvents = 'auto';
                            }, 400);
                        }
                    }, remaining);
                }
            }
        };

        // Block interaction immediately
        document.body.style.pointerEvents = 'none';
        
        window.addEventListener('load', () => {
            window.__loader.windowLoaded = true;
            window.__loader.checkHide();
        });

        // --- 2. DIALOG SYSTEM (Replacing Alert) ---
        window.showDialog = function (message, title = "Notice", options = {}) {
            return new Promise((resolve) => {
                const backdrop = document.getElementById("okBackdrop");
                const titleEl = document.getElementById("okTitle");
                const msgEl = document.getElementById("okMessage");
                const btnOk = document.getElementById("okConfirm");
                const btnCancel = document.getElementById("okCancel");

                titleEl.textContent = title;
                msgEl.textContent = message;
                btnOk.textContent = options.okText || "OK";
                btnCancel.textContent = options.cancelText || "Cancel";

                if(options.hideCancel) btnCancel.style.display = 'none';
                else btnCancel.style.display = 'block';

                backdrop.style.display = "flex";
                // Force reflow
                void backdrop.offsetWidth;
                backdrop.classList.add("active");

                const cleanup = (result) => {
                    backdrop.classList.remove("active");
                    setTimeout(() => {
                        backdrop.style.display = "none";
                        resolve(result);
                    }, 200);
                };

                btnOk.onclick = () => cleanup(true);
                btnCancel.onclick = () => cleanup(false);
            });
        };

        // --- 3. NAVIGATION & UI LOGIC ---
        function navigate(fromId, toId, triggerIntro = false) {
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);
            fromEl.classList.remove('active');
            setTimeout(() => {
                fromEl.classList.add('hidden-screen');
                toEl.classList.remove('hidden-screen');
                void toEl.offsetWidth; 
                toEl.classList.add('active');
                if (triggerIntro && toId === 'introScreen') {
                    const mascot = document.getElementById('introMascot');
                    mascot.classList.remove('pop-in');
                    void mascot.offsetWidth;
                    mascot.classList.add('pop-in');
                    triggerConfetti();
                }
            }, 300);
        }

        // global flag to track sign-up mode
        window.isSignupMode = false;

        // toggleLogin optionally accepts signup flag
        function toggleLogin(show, signup = false) {
            const login = document.getElementById('loginScreen');
            const titleEl = document.getElementById('loginHeading');
            const signInBtn = document.getElementById('signInBtn');
            window.isSignupMode = !!signup;

            if (show) {
                titleEl.textContent = window.isSignupMode ? 'Create your account' : 'Enter your details';
                signInBtn.textContent = window.isSignupMode ? 'Sign Up' : 'Sign In';
                login.classList.remove('hidden');
                requestAnimationFrame(() => {
                    login.classList.remove('opacity-0', 'translate-y-10');
                });
            } else {
                login.classList.add('opacity-0', 'translate-y-10');
                setTimeout(() => {
                    login.classList.add('hidden');
                    // reset to sign-in defaults
                    window.isSignupMode = false;
                    titleEl.textContent = 'Enter your details';
                    signInBtn.textContent = 'Sign In';
                }, 300);
            }
        }

        // show signup modal
        function toggleSignup() {
            toggleLogin(true, true);
        }

        function togglePassword() {
            const passInput = document.getElementById('loginPassword');
            passInput.type = passInput.type === "password" ? "text" : "password";
        }

        // When user presses Continue on intro screen we mark guest and redirect
        function continueAsGuest() {
            // mark guest mode so homepage can skip auth
            localStorage.setItem("skip", "true");
            // keep loader behavior consistent with auth flow
            window.__loader.redirecting = true;
            // show loader
            const loader = document.getElementById('loaderScreen');
            if (loader) {
                loader.style.display = 'flex';
                loader.style.opacity = '1';
            }
            // go to homepage
            setTimeout(() => {
                window.location.href = 'homepage.html';
            }, 200);
        }

        function triggerConfetti() {
            const container = document.querySelector('#confetti-container > div');
            if (!container) return;
            container.innerHTML = '';
            const colors = ['#60A5FA', '#F59E0B', '#FFFFFF', '#BFDBFE', '#3B82F6'];
            const animations = ['explode-1', 'explode-2', 'explode-3', 'explode-4', 'explode-5', 'explode-6'];
            for (let i = 0; i < 40; i++) {
                const piece = document.createElement('div');
                piece.classList.add('confetti-piece');
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const animation = animations[Math.floor(Math.random() * animations.length)];
                const duration = 0.6 + Math.random() * 0.4; 
                const randomX = (Math.random() - 0.5) * 20;
                const randomY = (Math.random() - 0.5) * 20;
                piece.style.transform = `translate(${randomX}px, ${randomY}px)`;
                piece.style.animation = `${animation} ${duration}s cubic-bezier(0.25, 1, 0.5, 1) forwards`;
                container.appendChild(piece);
            }
        }
        // expose continueAsGuest if needed externally
        window.continueAsGuest = continueAsGuest;
        window.toggleSignup = toggleSignup;
    </script>

    <!-- Auto-open login/signup when page loaded with hash or action param -->
    <script>
        (function openAuthFromUrl() {
            // This should run after toggleLogin / toggleSignup are defined above.
            try {
                const hash = (location.hash || '').replace('#', '').toLowerCase();
                const params = new URLSearchParams(location.search);
                const action = params.get('action') ? params.get('action').toLowerCase() : null;

                if (hash === 'login' || action === 'login') {
                    // open sign-in modal
                    toggleLogin(true, false);
                } else if (hash === 'signup' || action === 'signup') {
                    // open signup modal
                    toggleLogin(true, true);
                }
            } catch (e) {
                console.warn('openAuthFromUrl failed', e);
            }
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithEmailAndPassword, GoogleAuthProvider, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADgcz_naQ_5tpXcpI8tSvm1b4RVLDrlaw",
            authDomain: "medxcel.firebaseapp.com",
            projectId: "medxcel",
            storageBucket: "medxcel.firebasestorage.app",
            messagingSenderId: "649180317389",
            appId: "1:649180317389:web:f6b9a7053a37853ea04b84",
            measurementId: "G-6VQYKEBMSX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        window.suppressAuthRedirect = false;

        // --- AUTH STATE LISTENER ---
        onAuthStateChanged(auth, (user) => {
            // Signal loader that auth is checked
            window.__loader.authResolved = true;

            const skip = localStorage.getItem("skip") === "true";

            if (window.suppressAuthRedirect) {
                // If we are actively logging in, don't auto-redirect yet
                return;
            }

            if (user || skip) {
                // Keep loader UP and redirect
                window.__loader.redirecting = true;
                window.location.href = 'homepage.html';
            } else {
                // Not logged in -> Hide Loader
                window.__loader.checkHide();
            }
        });

        // --- GOOGLE LOGIN ---
        const googleBtn = document.getElementById('googleLoginBtn');
        if (googleBtn) {
            googleBtn.addEventListener('click', async () => {
                window.suppressAuthRedirect = true;
                try {
                    const result = await signInWithPopup(auth, provider);
                    // Success -> Set redirect flag
                    window.__loader.redirecting = true;
                    // Show generic loader text
                    document.querySelector('.loading-text').textContent = "LOGGING IN...";
                    document.getElementById('loaderScreen').style.display = 'flex';
                    document.getElementById('loaderScreen').style.opacity = '1';
                    
                    localStorage.removeItem("skip");
                    setTimeout(() => window.location.href = 'homepage.html', 500);
                } catch (error) {
                    window.suppressAuthRedirect = false;
                    await showDialog(error.message, "Login Failed", { hideCancel: true });
                }
            });
        }

        // --- EMAIL SIGN IN / SIGN UP ---
        const emailBtn = document.getElementById('signInBtn');
        if (emailBtn) {
            emailBtn.addEventListener('click', async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('loginPassword').value;
                
                if(!email || !pass) {
                    await showDialog("Please enter both email and password.", "Missing Info", { hideCancel: true });
                    return;
                }

                window.suppressAuthRedirect = true;

                // If in signup mode, create account instead
                if (window.isSignupMode) {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        // Signed up and logged in
                        window.__loader.redirecting = true;
                        localStorage.removeItem("skip");
                        window.location.href = 'homepage.html';
                    } catch (error) {
                        window.suppressAuthRedirect = false;
                        await showDialog(error.message, "Sign Up Failed", { hideCancel: true });
                    }
                } else {
                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        window.__loader.redirecting = true;
                        localStorage.removeItem("skip");
                        window.location.href = 'homepage.html';
                    } catch (error) {
                        window.suppressAuthRedirect = false;
                        await showDialog(error.message, "Login Failed", { hideCancel: true });
                    }
                }
            });
        }
    </script>
</body>
</html>